<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru - Jago Perkalian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body {
            font-family: 'Quicksand', sans-serif;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">

    <!-- HEADER -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-20">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-3 rounded-xl text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-slate-800">Dashboard Guru</h1>
                    <p class="text-sm text-slate-500">Jago Perkalian - Monitoring Nilai Siswa</p>
                </div>
            </div>

            <button onclick="refreshData()"
                class="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" />
                </svg>
                Refresh
            </button>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 animate-fade-in">
            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-semibold uppercase">Total Siswa</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="total-students">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-blue-600">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-semibold uppercase">Total Sesi</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="total-sessions">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-green-600">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-semibold uppercase">Rata-rata Nilai</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="average-score">0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-purple-600">
                            <path d="M3 3v18h18" />
                            <path d="m19 9-5 5-4-4-3 3" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-orange-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-slate-500 text-sm font-semibold uppercase">Nilai Tertinggi</p>
                        <p class="text-3xl font-bold text-slate-800 mt-2" id="highest-score">0</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-xl">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-orange-600">
                            <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                            <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                            <path d="M4 22h16" />
                            <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                            <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                            <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 animate-fade-in">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1">
                    <label class="block text-slate-700 font-semibold mb-2">Filter Kelas</label>
                    <select id="filter-class" onchange="filterData()"
                        class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-200 transition-all">
                        <option value="">Semua Kelas</option>
                        <option value="2A">2A</option>
                        <option value="2B">2B</option>
                        <option value="2C">2C</option>
                        <option value="2D">2D</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="block text-slate-700 font-semibold mb-2">Filter Jenis Quiz</label>
                    <select id="filter-quiz" onchange="filterData()"
                        class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-200 transition-all">
                        <option value="">Semua Jenis</option>
                        <option value="quiz-easy">Latihan Dasar (1-5)</option>
                        <option value="quiz-hard">Tantangan Pro (6-10)</option>
                        <option value="quiz-image">Latihan Gambar</option>
                        <option value="quiz-story">Soal Cerita</option>
                    </select>
                </div>
                <button onclick="exportToCSV()"
                    class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold transition-all shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" x2="12" y1="15" y2="3" />
                    </svg>
                    Export CSV
                </button>
            </div>
        </div>

        <!-- Sessions Table -->
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden animate-fade-in">
            <div class="p-6 bg-gradient-to-r from-purple-500 to-pink-500">
                <h2 class="text-2xl font-bold text-white">Daftar Nilai Siswa</h2>
                <p class="text-purple-100 mt-1">Klik pada baris untuk melihat detail jawaban</p>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-50 border-b-2 border-slate-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                No</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                Nama Siswa</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                Kelas</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                Jenis Quiz</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                Benar</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                Salah</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                Nilai</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                Waktu</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-600 uppercase tracking-wider">
                                Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-table-body" class="divide-y divide-slate-200">
                        <tr>
                            <td colspan="9" class="px-6 py-12 text-center text-slate-500">
                                <div class="flex flex-col items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round" class="text-slate-300">
                                        <circle cx="12" cy="12" r="10" />
                                        <line x1="12" x2="12" y1="8" y2="12" />
                                        <line x1="12" x2="12.01" y1="16" y2="16" />
                                    </svg>
                                    <p class="font-semibold">Memuat data...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detail-modal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden animate-fade-in">
                <div class="p-6 bg-gradient-to-r from-purple-500 to-pink-500 flex justify-between items-center">
                    <div>
                        <h3 class="text-2xl font-bold text-white" id="modal-title">Detail Jawaban</h3>
                        <p class="text-purple-100 mt-1" id="modal-subtitle"></p>
                    </div>
                    <button onclick="closeModal()"
                        class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 rounded-lg transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" x2="6" y1="6" y2="18" />
                            <line x1="6" x2="18" y1="6" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]" id="modal-content">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDSaIEF3LjVkNE_RTbAjIBi_gHzwJDqh7I",
            authDomain: "mediakreatif-sdanaksaleh.firebaseapp.com",
            databaseURL: "https://mediakreatif-sdanaksaleh-default-rtdb.firebaseio.com",
            projectId: "mediakreatif-sdanaksaleh",
            storageBucket: "mediakreatif-sdanaksaleh.firebasestorage.app",
            messagingSenderId: "635675085881",
            appId: "1:635675085881:web:f8e8d8b8f8e8d8b8f8e8d8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allSessions = [];
        let filteredSessions = [];

        const quizTypeNames = {
            'quiz-easy': 'Latihan Dasar (1-5)',
            'quiz-hard': 'Tantangan Pro (6-10)',
            'quiz-image': 'Latihan Gambar',
            'quiz-story': 'Soal Cerita'
        };

        // Load data from Firebase
        function loadData() {
            database.ref('jago-perkalian/sessions').once('value', (snapshot) => {
                allSessions = [];
                const data = snapshot.val();

                if (data) {
                    Object.keys(data).forEach(studentId => {
                        Object.keys(data[studentId]).forEach(sessionId => {
                            const session = data[studentId][sessionId];
                            if (session.summary) {
                                allSessions.push({
                                    studentId,
                                    sessionId,
                                    ...session.summary,
                                    answers: session.answers || {}
                                });
                            }
                        });
                    });
                }

                filteredSessions = [...allSessions];
                updateStatistics();
                renderTable();
            });
        }

        // Update statistics
        function updateStatistics() {
            const uniqueStudents = new Set(allSessions.map(s => s.studentId)).size;
            const totalSessions = allSessions.length;
            const scores = allSessions.map(s => s.finalScore);
            const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
            const maxScore = scores.length > 0 ? Math.max(...scores) : 0;

            document.getElementById('total-students').textContent = uniqueStudents;
            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('average-score').textContent = avgScore;
            document.getElementById('highest-score').textContent = maxScore;
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('sessions-table-body');

            if (filteredSessions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-slate-500">
                            <div class="flex flex-col items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300">
                                    <circle cx="12" cy="12" r="10"/>
                                    <line x1="12" x2="12" y1="8" y2="12"/>
                                    <line x1="12" x2="12.01" y1="16" y2="16"/>
                                </svg>
                                <p class="font-semibold">Tidak ada data</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredSessions.map((session, index) => {
                const date = new Date(session.completedAt);
                const formattedDate = date.toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const scorePercentage = (session.finalScore / 300) * 100;
                let scoreColor = 'text-red-600';
                if (scorePercentage >= 80) scoreColor = 'text-green-600';
                else if (scorePercentage >= 60) scoreColor = 'text-yellow-600';

                return `
                    <tr class="hover:bg-slate-50 transition-colors cursor-pointer" onclick="showDetail('${session.studentId}', '${session.sessionId}')">
                        <td class="px-6 py-4 text-sm text-slate-600">${index + 1}</td>
                        <td class="px-6 py-4">
                            <div class="font-semibold text-slate-800">${session.studentName}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">${session.studentClass}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">${quizTypeNames[session.quizType] || session.quizType}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">${session.correctAnswers}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-semibold">${session.wrongAnswers}</span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-lg font-bold ${scoreColor}">${session.finalScore}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-500">${formattedDate}</td>
                        <td class="px-6 py-4">
                            <button onclick="event.stopPropagation(); showDetail('${session.studentId}', '${session.sessionId}')" class="text-purple-600 hover:text-purple-800 font-semibold">
                                Detail →
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter data
        function filterData() {
            const classFilter = document.getElementById('filter-class').value;
            const quizFilter = document.getElementById('filter-quiz').value;

            filteredSessions = allSessions.filter(session => {
                const matchClass = !classFilter || session.studentClass === classFilter;
                const matchQuiz = !quizFilter || session.quizType === quizFilter;
                return matchClass && matchQuiz;
            });

            renderTable();
        }

        // Show detail modal
        function showDetail(studentId, sessionId) {
            const session = allSessions.find(s => s.studentId === studentId && s.sessionId === sessionId);
            if (!session) return;

            document.getElementById('modal-title').textContent = `Detail Jawaban - ${session.studentName}`;
            document.getElementById('modal-subtitle').textContent = `${session.studentClass} | ${quizTypeNames[session.quizType]} | Nilai: ${session.finalScore}`;

            const answers = session.answers;
            const answersArray = Object.values(answers).sort((a, b) => a.questionNumber - b.questionNumber);

            const content = `
                <div class="space-y-3">
                    ${answersArray.map(answer => `
                        <div class="flex items-center justify-between p-4 rounded-xl ${answer.isCorrect ? 'bg-green-50 border-2 border-green-200' : 'bg-red-50 border-2 border-red-200'}">
                            <div class="flex items-center gap-4">
                                <div class="text-2xl font-bold ${answer.isCorrect ? 'text-green-600' : 'text-red-600'}">
                                    ${answer.questionNumber}
                                </div>
                                <div>
                                    <p class="font-semibold text-slate-700">${answer.question} = ?</p>
                                    <p class="text-sm text-slate-500 mt-1">
                                        Jawaban: <span class="font-bold ${answer.isCorrect ? 'text-green-600' : 'text-red-600'}">${answer.userAnswer}</span>
                                        ${!answer.isCorrect ? `<span class="text-slate-400">| Benar: <span class="text-green-600 font-bold">${answer.correctAnswer}</span></span>` : ''}
                                    </p>
                                </div>
                            </div>
                            <div class="text-3xl">
                                ${answer.isCorrect ? '✅' : '❌'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('detail-modal').classList.add('hidden');
        }

        // Export to CSV
        function exportToCSV() {
            if (filteredSessions.length === 0) {
                alert('Tidak ada data untuk di-export');
                return;
            }

            let csv = 'No,Nama Siswa,Kelas,Jenis Quiz,Benar,Salah,Nilai,Waktu\n';

            filteredSessions.forEach((session, index) => {
                const date = new Date(session.completedAt).toLocaleString('id-ID');
                csv += `${index + 1},"${session.studentName}","${session.studentClass}","${quizTypeNames[session.quizType]}",${session.correctAnswers},${session.wrongAnswers},${session.finalScore},"${date}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `nilai-jago-perkalian-${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Refresh data
        function refreshData() {
            loadData();
        }

        // Initial load
        window.onload = loadData;
    </script>
</body>

</html>