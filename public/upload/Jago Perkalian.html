<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jago Perkalian - Belajar Matematika Seru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body {
            font-family: 'Quicksand', sans-serif;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .animate-shake {
            animation: shake 0.4s ease-in-out;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .animate-scale-in {
            animation: scaleIn 0.3s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body class="min-h-screen bg-sky-100 selection:bg-yellow-300">

    <!-- HEADER -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-20">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="goHome()">
                <div class="bg-yellow-400 p-2 rounded-lg text-white font-bold transform -rotate-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="16" height="20" x="4" y="2" rx="2" />
                        <line x1="8" x2="16" y1="6" y2="6" />
                        <line x1="16" x2="16" y1="14" y2="18" />
                        <path d="M16 10h.01" />
                        <path d="M12 10h.01" />
                        <path d="M8 10h.01" />
                        <path d="M12 14h.01" />
                        <path d="M8 14h.01" />
                        <path d="M12 18h.01" />
                        <path d="M8 18h.01" />
                    </svg>
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-sky-600">Jago Perkalian</h1>
            </div>

            <div class="flex items-center gap-3">
                <div id="student-info" class="hidden bg-green-50 px-4 py-2 rounded-full border border-green-200">
                    <span class="text-sm font-semibold text-green-700" id="student-name-display"></span>
                </div>
                <div id="score-container"
                    class="hidden flex items-center gap-3 bg-sky-50 px-4 py-2 rounded-full border border-sky-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-yellow-500">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                        <path d="M4 22h16" />
                        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
                    </svg>
                    <span id="score-text" class="font-bold text-sky-700">0 Poin</span>
                </div>
            </div>
        </div>
    </header>


    <main id="main-content" class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Views akan di-render di sini oleh JavaScript -->
    </main>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAEMyJQDtwoeAPQHr1SduLeHuA4Hu-lDdU",
            authDomain: "mediakreatif-sdanaksaleh.firebaseapp.com",
            databaseURL: "https://mediakreatif-sdanaksaleh-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "mediakreatif-sdanaksaleh",
            storageBucket: "mediakreatif-sdanaksaleh.firebasestorage.app",
            messagingSenderId: "1096718379968",
            appId: "1:1096718379968:web:9ba2a4dfc2a4343a2ef625"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // State Management
        let view = 'login';
        let score = 0;
        let questionCount = 0;
        let currentQuestion = null;
        let isFeedbackActive = false;
        const TOTAL_QUESTIONS = 30;

        // Student Data
        let studentData = {
            id: null,
            name: '',
            class: '',
            sessionId: null,
            answers: []
        };

        const praiseMessages = ["Luar Biasa!", "Hebat Sekali!", "Kamu Cerdas!", "Kerja Bagus!", "Mantap Jiwa!", "Sempurna!", "Keren Abis!", "Jempolan!", "Wow, Benar!"];
        const motivationMessages = ["Jangan Menyerah!", "Ayo Coba Lagi!", "Tetap Semangat!", "Belajar dari Kesalahan!", "Kamu Pasti Bisa!", "Hampir Benar!", "Jangan Putus Asa!", "Coba Fokus Lagi!"];

        const storyTemplates = [
            { text: "Ibu membeli {num1} keranjang buah. Setiap keranjang berisi {num2} apel. Berapa jumlah apel seluruhnya?", icon: 'üçé' },
            { text: "Di garasi ada {num1} mobil mainan. Setiap mobil memiliki {num2} roda. Berapa jumlah roda seluruhnya?", icon: 'üöó' },
            { text: "Budi punya {num1} kotak kue. Satu kotak isinya {num2} kue. Berapa total kue Budi?", icon: 'üç™' },
            { text: "Seekor kucing punya {num2} kaki. Jika ada {num1} kucing, berapa jumlah kakinya?", icon: 'üêà' },
            { text: "Setiap hari Ani menabung {num2} ribu. Berapa tabungan Ani selama {num1} hari? (dalam ribu)", icon: 'üí∞' },
            { text: "Ada {num1} vas bunga. Setiap vas diisi {num2} bunga mawar. Berapa total bunga mawar?", icon: 'üåπ' }
        ];

        function render() {
            const main = document.getElementById('main-content');
            const scoreContainer = document.getElementById('score-container');
            const scoreText = document.getElementById('score-text');
            const studentInfo = document.getElementById('student-info');
            const studentNameDisplay = document.getElementById('student-name-display');

            // Handle Header Score Visibility
            if (view === 'login' || view === 'home' || view === 'materi' || view === 'finished') {
                scoreContainer.classList.add('hidden');
            } else {
                scoreContainer.classList.remove('hidden');
                scoreText.innerText = `${score} Poin`;
            }

            // Handle Student Info Visibility
            if (view === 'login') {
                studentInfo.classList.add('hidden');
            } else {
                studentInfo.classList.remove('hidden');
                studentNameDisplay.innerText = `${studentData.name} - ${studentData.class}`;
            }

            if (view === 'login') {
                main.innerHTML = `
                    <div class="animate-scale-in max-w-md mx-auto mt-10">
                        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 border-t-8 border-sky-400">
                            <div class="text-center mb-8">
                                <div class="text-6xl mb-4">üìö</div>
                                <h2 class="text-3xl font-bold text-slate-800 mb-2">Selamat Datang!</h2>
                                <p class="text-slate-500">Silakan isi data diri kamu terlebih dahulu</p>
                            </div>
                            <form onsubmit="handleLogin(event)" class="space-y-4">
                                <div>
                                    <label class="block text-slate-700 font-semibold mb-2">Nama Lengkap</label>
                                    <input 
                                        type="text" 
                                        id="student-name" 
                                        required
                                        class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200 transition-all"
                                        placeholder="Masukkan nama lengkap"
                                    >
                                </div>
                                <div>
                                    <label class="block text-slate-700 font-semibold mb-2">Kelas</label>
                                    <select 
                                        id="student-class" 
                                        required
                                        class="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200 transition-all"
                                    >
                                        <option value="">Pilih Kelas</option>
                                        <option value="2A">2A</option>
                                        <option value="2B">2B</option>
                                        <option value="2C">2C</option>
                                        <option value="2D">2D</option>
                                    </select>
                                </div>
                                <button 
                                    type="submit"
                                    class="w-full py-4 bg-gradient-to-r from-sky-500 to-blue-500 hover:from-sky-600 hover:to-blue-600 text-white rounded-xl font-bold text-lg shadow-lg transform hover:scale-105 transition-all"
                                >
                                    Mulai Belajar üöÄ
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            } else if (view === 'home') {
                main.innerHTML = `
                    <div class="flex flex-col items-center animate-fade-in">
                        <div class="text-center mb-10 mt-4">
                            <h2 class="text-3xl md:text-4xl font-bold text-slate-700 mb-3">Mau belajar apa hari ini?</h2>
                            <p class="text-slate-500 text-lg">Pilih menu di bawah ini untuk memulai petualanganmu!</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
                            ${renderMenuCard('materi', 'emerald', 'Materi & Video', 'Tonton video dan hafalan', '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>')}
                            ${renderMenuCard('quiz-easy', 'blue', 'Latihan Dasar', '30 Soal Angka 1-5', '<span class="text-xl font-bold">1-5</span>')}
                            ${renderMenuCard('quiz-hard', 'purple', 'Tantangan Pro', '30 Soal Angka 6-10', '<span class="text-xl font-bold">6-10</span>')}
                            ${renderMenuCard('quiz-image', 'orange', 'Latihan Gambar', 'Belajar dengan visual seru', '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>')}
                            ${renderMenuCard('quiz-story', 'pink', 'Soal Cerita', 'Pecahkan teka-teki cerita', '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>')}
                        </div>
                    </div>
                `;
            } else if (view === 'materi') {
                main.innerHTML = `
                    <div class="animate-fade-in">
                        <div class="flex items-center gap-4 mb-6">
                            <button onclick="goHome()" class="bg-white p-2 rounded-full hover:bg-slate-100 shadow text-slate-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                            </button>
                            <h2 class="text-2xl font-bold text-slate-700">Materi & Hafalan</h2>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-pink-500">
                            <h3 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <div class="bg-pink-500 text-white p-1.5 rounded-lg">‚ñ∂</div>
                                Video Belajar Perkalian Ceria
                            </h3>
                            <div class="aspect-video w-full rounded-lg overflow-hidden bg-slate-900 shadow-inner">
                                <iframe width="100%" height="100%" src="https://www.youtube.com/embed/CPSb5BJhc9E?si=md0dZFtkMqmm1Bic" frameborder="0" allowfullscreen></iframe>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(num => `
                                <div class="bg-white rounded-xl shadow p-4 border-t-4 border-sky-400">
                                    <h3 class="text-center font-bold text-sky-600 mb-2 border-b pb-2">Perkalian ${num}</h3>
                                    <div class="space-y-1 text-slate-600 font-mono text-sm text-center">
                                        ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(m => `<div class="flex justify-between px-2"><span>${num}x${m}</span><b>=${num * m}</b></div>`).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="mt-10 mb-6 text-center">
                            <div class="bg-white p-6 rounded-2xl shadow-lg max-w-2xl mx-auto border-2 border-green-100">
                                <h3 class="text-xl font-bold text-slate-700 mb-2">Sudah Selesai Belajar?</h3>
                                <p class="text-slate-500 mb-6">Jika kamu sudah menonton video dan menghafal perkalian, klik tombol di bawah ini ya!</p>
                                <button onclick="verifyStudy()" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-xl shadow-lg transform hover:scale-105 transition-all flex items-center gap-3 mx-auto text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                    Saya Sudah Menonton & Membaca Materi
                                </button>
                            </div>
                        </div>

                        <div id="feedback-overlay" class="hidden fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in z-50">
                            <div id="feedback-content" class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl transform scale-100 transition-all text-center relative">
                            </div>
                        </div>
                    </div>
                `;
            } else if (view.startsWith('quiz')) {
                const progress = (questionCount / TOTAL_QUESTIONS) * 100;
                main.innerHTML = `
                    <div class="animate-scale-in max-w-2xl mx-auto">
                        <div class="flex items-center gap-4 mb-8">
                            <button onclick="goHome()" class="bg-white p-2 rounded-full hover:bg-slate-100 shadow text-slate-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                            </button>
                            <div class="flex-1">
                                <div class="flex justify-between text-sm font-bold text-slate-600 mb-1">
                                    <span>Progres</span>
                                    <span>${questionCount} / ${TOTAL_QUESTIONS} Soal</span>
                                </div>
                                <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 transition-all duration-500 rounded-full" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-3xl shadow-xl p-8 md:p-12 text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400"></div>
                            <div class="mb-8">
                                <p class="text-slate-400 font-medium mb-4">Soal Nomor ${questionCount}</p>
                                ${renderQuizContent()}
                            </div>

                            ${view === 'quiz-story' ? `
                                <div class="max-w-3xl mx-auto">
                                    <div class="flex flex-col items-center">
                                        <label class="block text-slate-600 font-semibold mb-4">Isi kotak sesuai cerita di atas:</label>
                                        <div class="flex items-center justify-center gap-2 md:gap-4 mb-8">
                                            <div class="relative">
                                                <input type="number" id="input-n1" class="w-20 h-20 md:w-24 md:h-24 text-3xl md:text-4xl font-bold text-center border-4 border-slate-200 rounded-2xl focus:border-blue-500 focus:outline-none text-slate-700 bg-slate-50 shadow-inner" placeholder="?" autofocus onkeypress="if(event.key === 'Enter') document.getElementById('input-n2').focus()">
                                            </div>
                                            <span class="text-3xl font-bold text-slate-400">√ó</span>
                                            <div class="relative">
                                                <input type="number" id="input-n2" class="w-20 h-20 md:w-24 md:h-24 text-3xl md:text-4xl font-bold text-center border-4 border-slate-200 rounded-2xl focus:border-blue-500 focus:outline-none text-slate-700 bg-slate-50 shadow-inner" placeholder="?" onkeypress="if(event.key === 'Enter') document.getElementById('input-res').focus()">
                                            </div>
                                            <span class="text-3xl font-bold text-slate-400">=</span>
                                            <div class="relative">
                                                <input type="number" id="input-res" class="w-24 h-24 md:w-32 md:h-32 text-4xl md:text-5xl font-bold text-center border-4 border-slate-200 rounded-2xl focus:border-blue-500 focus:outline-none text-slate-700 bg-slate-50 shadow-inner" placeholder="?" onkeypress="if(event.key === 'Enter') submitAnswer()">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : `
                                <div class="flex justify-center gap-4 mb-8">
                                    ${view === 'quiz-image' ? '' : `
                                        <div class="text-5xl md:text-7xl font-bold text-slate-700">${currentQuestion.num1}</div>
                                        <div class="text-5xl md:text-7xl font-bold text-slate-400">√ó</div>
                                        <div class="text-5xl md:text-7xl font-bold text-slate-700">${currentQuestion.num2}</div>
                                        <div class="text-5xl md:text-7xl font-bold text-slate-400">=</div>
                                        <div class="text-5xl md:text-7xl font-bold text-blue-600">?</div>
                                    `}
                                </div>
                            `}

                            <div class="grid grid-cols-2 gap-4 max-w-lg mx-auto ${view === 'quiz-story' ? 'hidden' : ''}">
                                ${currentQuestion.options.map((opt, idx) => `
                                    <button 
                                        onclick="submitAnswer('${opt}')"
                                        class="py-4 px-6 bg-slate-50 hover:bg-blue-50 border-2 border-slate-200 hover:border-blue-400 rounded-xl text-2xl font-bold text-slate-600 hover:text-blue-600 transition-all transform hover:scale-105 shadow-sm hover:shadow-md"
                                    >
                                        ${opt}
                                    </button>
                                `).join('')}
                            </div>

                            ${view === 'quiz-story' ? `
                                <button onclick="submitAnswer()" class="mt-8 py-3 px-8 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg transform hover:scale-105 transition-all">
                                    Jawab
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else if (view === 'finished') {
                let message = "";
                let emoji = "";
                let color = "";

                if (score >= 90) {
                    message = "Luar Biasa! Kamu Jenius Perkalian!";
                    emoji = "üèÜ";
                    color = "text-yellow-500";
                } else if (score >= 70) {
                    message = "Hebat! Terus Berlatih ya!";
                    emoji = "üåü";
                    color = "text-blue-500";
                } else {
                    message = "Jangan Menyerah! Ayo Coba Lagi!";
                    emoji = "üí™";
                    color = "text-green-500";
                }

                main.innerHTML = `
                    <div class="animate-scale-in max-w-md mx-auto text-center mt-10">
                        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 border-t-8 ${score >= 70 ? 'border-yellow-400' : 'border-slate-400'}">
                            <div class="text-8xl mb-6 animate-bounce">${emoji}</div>
                            <h2 class="text-3xl font-bold text-slate-800 mb-2">Selesai!</h2>
                            <p class="text-xl ${color} font-bold mb-6">${message}</p>
                            
                            <div class="bg-slate-50 rounded-2xl p-6 mb-8 border border-slate-100">
                                <p class="text-slate-500 mb-2">Skor Akhir Kamu</p>
                                <div class="text-6xl font-black text-slate-800 mb-2">${score}</div>
                                <div class="text-sm text-slate-400 font-medium">dari 100 Poin</div>
                            </div>

                            <div class="space-y-3">
                                <button onclick="goHome()" class="w-full py-4 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold text-lg transition-all">
                                    Kembali ke Menu
                                </button>
                                <button onclick="startQuiz(view)" class="w-full py-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-bold text-lg shadow-lg transition-all">
                                    Main Lagi üîÑ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderMenuCard(viewName, color, title, desc, icon) {
            const colors = {
                emerald: 'bg-emerald-500 hover:bg-emerald-600 shadow-emerald-200',
                blue: 'bg-blue-500 hover:bg-blue-600 shadow-blue-200',
                purple: 'bg-purple-500 hover:bg-purple-600 shadow-purple-200',
                orange: 'bg-orange-500 hover:bg-orange-600 shadow-orange-200',
                pink: 'bg-pink-500 hover:bg-pink-600 shadow-pink-200'
            };

            return `
                <div onclick="startQuiz('${viewName}')" class="group relative bg-white rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all cursor-pointer transform hover:-translate-y-2 border-2 border-transparent hover:border-${color}-200 overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110">
                        ${icon}
                    </div>
                    <div class="${colors[color]} w-14 h-14 rounded-2xl flex items-center justify-center text-white mb-4 shadow-lg transition-transform group-hover:rotate-6">
                        ${typeof icon === 'string' && icon.includes('<svg') ? icon : icon}
                    </div>
                    <h3 class="text-xl font-bold text-slate-700 mb-1 group-hover:text-${color}-600 transition-colors">${title}</h3>
                    <p class="text-slate-500 text-sm">${desc}</p>
                </div>
            `;
        }

        function renderQuizContent() {
            if (view === 'quiz-image') {
                return `
                    <div class="flex justify-center items-center gap-4 mb-8">
                        <div class="bg-orange-50 p-4 rounded-2xl border-2 border-orange-100">
                            <div class="grid grid-cols-2 gap-2">
                                ${Array(currentQuestion.num1).fill(0).map(() => `
                                    <div class="w-12 h-12 bg-white rounded-lg shadow-sm flex items-center justify-center text-2xl border border-orange-100">üçé</div>
                                `).join('')}
                            </div>
                            <div class="text-center mt-2 font-bold text-orange-400">${currentQuestion.num1} Kelompok</div>
                        </div>
                        <div class="text-4xl font-bold text-slate-300">√ó</div>
                        <div class="bg-orange-50 p-4 rounded-2xl border-2 border-orange-100">
                            <div class="w-12 h-12 bg-white rounded-lg shadow-sm flex items-center justify-center text-2xl border border-orange-100">üçé</div>
                            <div class="text-center mt-2 font-bold text-orange-400">${currentQuestion.num2} Apel</div>
                        </div>
                    </div>
                `;
            } else if (view === 'quiz-story') {
                return `
                    <div class="bg-pink-50 p-6 rounded-2xl border-2 border-pink-100 text-lg text-slate-700 leading-relaxed font-medium mb-6">
                        ${currentQuestion.question}
                    </div>
                `;
            }
            return '';
        }

        function handleLogin(e) {
            e.preventDefault();
            const name = document.getElementById('student-name').value;
            const className = document.getElementById('student-class').value;

            if (name && className) {
                studentData.name = name;
                studentData.class = className;
                studentData.id = `${name.replace(/\s+/g, '_').toLowerCase()}_${Date.now()}`;

                view = 'home';
                render();
            }
        }

        function goHome() {
            view = 'home';
            render();
        }

        function startQuiz(selectedView) {
            view = selectedView;
            if (view === 'materi') {
                render();
                return;
            }

            score = 0;
            questionCount = 1;
            studentData.answers = [];

            // Generate Session ID
            studentData.sessionId = `session_${Date.now()}`;

            generateQuestion();
            render();
        }

        function generateQuestion() {
            let num1, num2;

            if (view === 'quiz-easy') {
                num1 = Math.floor(Math.random() * 5) + 1;
                num2 = Math.floor(Math.random() * 10) + 1;
            } else {
                num1 = Math.floor(Math.random() * 5) + 6; // 6-10
                num2 = Math.floor(Math.random() * 10) + 1;
            }

            // Handle Quiz Story
            if (view === 'quiz-story') {
                const correctAnswer = num1 * num2;
                const template = storyTemplates[Math.floor(Math.random() * storyTemplates.length)];
                const questionText = template.text.replace('{num1}', num1).replace('{num2}', num2);
                currentQuestion = {
                    num1, num2, correctAnswer,
                    question: questionText,
                    icon: template.icon,
                    options: []
                };
                return;
            }

            // Handle Quiz Image
            if (view === 'quiz-image') {
                const correctString = `${num1} x ${num2} = ${num1 * num2}`;
                let options = [correctString];

                while (options.length < 4) {
                    let w1 = Math.floor(Math.random() * 5) + 6;
                    let w2 = Math.floor(Math.random() * 10) + 1;

                    if (w1 === num1 && w2 === num2) continue;

                    const wrongString = `${w1} x ${w2} = ${w1 * w2}`;
                    if (!options.includes(wrongString)) {
                        options.push(wrongString);
                    }
                }
                options.sort(() => Math.random() - 0.5);

                currentQuestion = {
                    num1, num2,
                    correctAnswer: correctString,
                    options
                };
                return;
            }

            // Standard Quiz
            const correctAnswer = num1 * num2;
            let options = [correctAnswer];

            while (options.length < 4) {
                let wrong = correctAnswer + Math.floor(Math.random() * 10) - 5;
                if (wrong > 0 && !options.includes(wrong)) {
                    options.push(wrong);
                }
            }
            options.sort(() => Math.random() - 0.5);

            currentQuestion = { num1, num2, correctAnswer, options };
        }

        function submitAnswer(answer) {
            if (isFeedbackActive) return;

            let isCorrect = false;
            let userAnswer = answer;

            if (view === 'quiz-story') {
                const n1 = parseInt(document.getElementById('input-n1').value);
                const n2 = parseInt(document.getElementById('input-n2').value);
                const res = parseInt(document.getElementById('input-res').value);

                userAnswer = `${n1} x ${n2} = ${res}`;

                const numbersMatch = (n1 === currentQuestion.num1 && n2 === currentQuestion.num2) || (n1 === currentQuestion.num2 && n2 === currentQuestion.num1);

                if (numbersMatch && res === currentQuestion.correctAnswer) {
                    isCorrect = true;
                }
            } else {
                if (answer == currentQuestion.correctAnswer) {
                    isCorrect = true;
                }
            }

            handleAnswer(isCorrect, userAnswer);
        }

        function handleAnswer(isCorrect, userAnswer) {
            isFeedbackActive = true;
            const overlay = document.getElementById('feedback-overlay');
            const content = document.getElementById('feedback-content');

            overlay.classList.remove('hidden');

            if (isCorrect) {
                score += Math.round(100 / TOTAL_QUESTIONS);
                const praise = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
                content.innerHTML = `
                    <div class="text-6xl mb-4 animate-bounce">üéâ</div>
                    <h3 class="text-2xl font-bold text-green-500 mb-2">Benar!</h3>
                    <p class="text-slate-600 font-medium">${praise}</p>
                `;
                playSound('correct');
            } else {
                const motivation = motivationMessages[Math.floor(Math.random() * motivationMessages.length)];
                content.innerHTML = `
                    <div class="text-6xl mb-4 animate-shake">üò¢</div>
                    <h3 class="text-2xl font-bold text-red-500 mb-2">Yah, Salah...</h3>
                    <p class="text-slate-600 mb-4">${motivation}</p>
                    <div class="bg-slate-100 p-3 rounded-xl inline-block">
                        <span class="text-slate-500 text-sm">Jawaban yang benar:</span>
                        <div class="text-xl font-bold text-slate-700 mt-1">
                            ${currentQuestion.num1} √ó ${currentQuestion.num2} = ${currentQuestion.correctAnswer}
                        </div>
                    </div>
                `;
                playSound('wrong');
            }

            // Save Answer to Firebase
            const answerData = {
                question: view === 'quiz-story' ? currentQuestion.question : `${currentQuestion.num1} x ${currentQuestion.num2}`,
                userAnswer: userAnswer,
                correctAnswer: currentQuestion.correctAnswer,
                isCorrect: isCorrect,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            studentData.answers.push(answerData);

            // Save individual answer to Firebase
            if (studentData.id && studentData.sessionId) {
                database.ref(`jago-perkalian/sessions/${studentData.id}/${studentData.sessionId}/answers`).push(answerData);
            }

            setTimeout(() => {
                overlay.classList.add('hidden');
                isFeedbackActive = false;

                if (questionCount < TOTAL_QUESTIONS) {
                    questionCount++;
                    generateQuestion();
                    render();
                } else {
                    saveSessionSummary();
                    view = 'finished';
                    render();
                }
            }, 2000);
        }

        function verifyStudy() {
            if (!studentData.id) {
                alert("Silakan login terlebih dahulu!");
                view = 'login';
                render();
                return;
            }

            const studySessionId = `study_${Date.now()}`;
            const studyData = {
                verified: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                studentName: studentData.name,
                studentClass: studentData.class
            };

            database.ref(`jago-perkalian/sessions/${studentData.id}/${studySessionId}/studied`).set(studyData)
                .then(() => {
                    alert("Hebat! Kamu sudah menyelesaikan materi belajar. Sekarang ayo kita latihan soal!");
                    view = 'home';
                    render();
                })
                .catch((error) => {
                    console.error("Error saving study verification:", error);
                    alert("Terjadi kesalahan saat menyimpan data. Coba lagi ya.");
                });
        }

        function saveSessionSummary() {
            if (!studentData.id || !studentData.sessionId) return;

            const correctCount = studentData.answers.filter(a => a.isCorrect).length;
            const wrongCount = studentData.answers.length - correctCount;

            const summary = {
                studentName: studentData.name,
                studentClass: studentData.class,
                quizType: view,
                totalQuestions: TOTAL_QUESTIONS,
                correctAnswers: correctCount,
                wrongAnswers: wrongCount,
                finalScore: score,
                completedAt: firebase.database.ServerValue.TIMESTAMP
            };

            database.ref(`jago-perkalian/sessions/${studentData.id}/${studentData.sessionId}/summary`).set(summary);
        }

        function playSound(type) {
            // Placeholder for sound effects
            // const audio = new Audio(type === 'correct' ? 'correct.mp3' : 'wrong.mp3');
            // audio.play();
        }

        // Initial Render
        window.onload = render;

    </script>
</body>

</html>